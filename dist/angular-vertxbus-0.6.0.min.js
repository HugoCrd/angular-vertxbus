(function(){var a,b,c={}.hasOwnProperty;a={enabled:!0,debugEnabled:!1,prefix:"vertx-eventbus.",urlServer:""+location.protocol+"//"+location.hostname+":"+(location.port||80),urlPath:"/eventbus",reconnectEnabled:!0,sockjsStateInterval:1e4,sockjsReconnectInterval:1e4,sockjsOptions:{},messageBuffer:0},b=angular.module("knalli.angular-vertxbus",["ng"]).constant("angularVertxbusOptions",angular.extend({},a)).provider("vertxEventBus",["angularVertxbusOptions",function(b){this.enable=function(c){return null==c&&(c=a.enabled),b.enabled=c===!0,this},this.useDebug=function(c){return null==c&&(c=a.debugEnabled),b.debugEnabled=c===!0,this},this.usePrefix=function(c){return null==c&&(c=a.prefix),b.prefix=c,this},this.useUrlServer=function(c){return null==c&&(c=a.urlServer),b.urlServer=c,this},this.useUrlPath=function(c){return null==c&&(c=a.urlPath),b.urlPath=c,this},this.useReconnect=function(c){return null==c&&(c=a.reconnectEnabled),b.reconnectEnabled=c,this},this.useSockJsStateInterval=function(c){return null==c&&(c=a.sockjsStateInterval),b.sockjsStateInterval=c,this},this.useSockJsReconnectInterval=function(c){return null==c&&(c=a.sockjsReconnectInterval),b.sockjsReconnectInterval=c,this},this.useSockJsOptions=function(c){return null==c&&(c=a.sockjsOptions),b.sockjsOptions=c,this},this.useMessageBuffer=function(c){return null==c&&(c=a.messageBuffer),b.messageBuffer=c,this},this.$get=["angularVertxbusOptions","$timeout",function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return r=angular.extend({},a,b),g=r.enabled,f=r.debugEnabled,i=r.prefix,q=r.urlServer,p=r.urlPath,j=r.reconnectEnabled,m=r.sockjsStateInterval,l=r.sockjsReconnectInterval,k=r.sockjsOptions,n=null,d="undefined"!=typeof vertx&&null!==vertx?vertx.EventBus:void 0,g&&d?(o=""+q+p,f&&console.debug("[Vertex EventBus] Enabled: connecting '"+o+"'"),h=null,e=function(){h=new d(o,void 0,k),h.onopen=function(){f&&console.debug("[VertX EventBus] Connected"),"function"==typeof n.onopen&&n.onopen()},h.onclose=function(){f&&console.debug("[VertX EventBus] Reconnect in "+l+"ms"),"function"==typeof n.onclose&&n.onclose(),j&&c(e,l)}},e(),n={reconnect:function(){return h.close()},close:function(){return h.close()},login:function(a,b,c){return h.login(a,b,c)},send:function(a,b,c){return h.send(a,b,c)},publish:function(a,b){return h.publish(a,b)},registerHandler:function(a,b){return h.registerHandler(a,b),function(){n.unregisterHandler(a,b)}},unregisterHandler:function(a,b){return h.unregisterHandler(a,b)},readyState:function(){return h.readyState()},EventBus:d}):f&&console.debug("[VertX EventBus] Disabled"),n}]}]),b.service("vertxEventBusService",["$rootScope","$q","$interval","$timeout","vertxEventBus","angularVertxbusOptions",function(b,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;return i=function(){function a(a){this.maxSize=null!=a?a:10,this.items=[]}return a.prototype.push=function(a){return this.items.push(a),this.recalibrateBufferSize()},a.prototype.recalibrateBufferSize=function(){for(;this.items.length>this.maxSize;)this.first();return this},a.prototype.last=function(){return this.items.pop()},a.prototype.first=function(){return this.items.shift(0)},a.prototype.size=function(){return this.items.length},a}(),z=angular.extend({},a,h),m=z.enabled,l=z.debugEnabled,q=z.prefix,w=z.urlServer,v=z.urlPath,r=z.reconnectEnabled,u=z.sockjsStateInterval,t=z.sockjsReconnectInterval,s=z.sockjsOptions,o=z.messageBuffer,k=null!=g&&null!=(A=g.EventBus)?A.CLOSED:void 0,p=new i(o),m&&g&&(g.onopen=function(){var a,d,e,f,g,h,i;y.getConnectionState(!0),b.$broadcast(""+q+"system.connected"),i=y.handlers;for(a in i)if(c.call(i,a))for(e=i[a],g=0,h=e.length;h>g;g++)d=e[g],x.registerHandler(a,d);if(b.$digest(),o&&p.size()){for(;p.size();)f=p.first(),"function"==typeof f&&f();b.$digest()}},g.onclose=function(){return y.getConnectionState(!0),b.$broadcast(""+q+"system.disconnected")}),n=function(a){return y.getConnectionState()===g.EventBus.OPEN?(a(),!0):o?(p.push(a),!0):!1},x={registerHandler:function(a,c){return"function"==typeof c?(l&&console.debug("[VertX EventBus] Register handler for "+a),g.registerHandler(a,function(a,d){return c(a,d),b.$digest()})):void 0},unregisterHandler:function(a,b){return"function"==typeof b?(l&&console.debug("[VertX EventBus] Unregister handler for "+a),g.unregisterHandler(a,b)):void 0},send:function(a,b,c,e){var h,i;return null==e&&(e=1e4),c&&(h=d.defer()),i=n(function(){return g.send(a,b,function(a){return h&&h.resolve(a),"function"==typeof c?c(a):void 0}),h?f(function(){return h.reject()},e):void 0}),h&&!i&&h.reject(),null!=h?h.promise:void 0},publish:function(a,b){var c;return c=n(function(){return g.publish(a,b)})}},y={handlers:{},registerHandler:function(a,b){return y.handlers[a]||(y.handlers[a]=[]),y.handlers[a].push(b),k===g.EventBus.OPEN&&x.registerHandler(a,b),function(){y.unregisterHandler(a,b)}},unregisterHandler:function(a,b){var c;return y.handlers[a]&&(c=y.handlers[a].indexOf(b),c>-1&&y.handlers[a].splice(c,1)),k===g.EventBus.OPEN?x.unregisterHandler(a,b):void 0},send:function(a,b,c,d){return null==d&&(d=1e4),x.send(a,b,c,d)},publish:function(a,b){return x.publish(a,b)},getConnectionState:function(a){return(null!=g?g.EventBus:void 0)?m?a&&(k=g.readyState()):k=g.EventBus.CLOSED:k=3,k}},e(function(){return y.getConnectionState(!0)},u),j={on:y.registerHandler,addListener:y.registerHandler,un:y.unregisterHandler,removeListener:y.unregisterHandler,send:y.send,publish:y.publish,emit:y.publish,readyState:y.getConnectionState,isEnabled:function(){return m},getBufferCount:function(){return p.size()}}}])}).call(this);